---
title: "Linux内存映射"
date: 2024-01-03 09:00:02 +0800
categories: linux
---

[原文地址](https://juejin.cn/post/7258150367119835196)

# 内存映射

内核会为每个物理内存页 page 进行统一编号。这个编号称之为 PFN（Page Frame Number），PFN 与 struct page 是一一对应的关系并且全局唯一。

给定一个虚拟内存地址，内核会先从这个虚拟内存地址中提取出 页表内偏移 ，然后根据 页表起始地址 + 页表内偏移 * sizeof(PTE) 就能获取到该虚拟内存地址所在虚拟页在页表中对应的 PTE 了。

> 在 32 位系统中页表中的 PTE 占用 4 个字节，64 位系统中页表的 PTE 占用 8 个字节。

页表的起始地址就存放在 struct mm_struct 结构中的 pgd 属性中。

当我们使用 fork 系统调用创建进程的时候，内核在 _do_fork 函数中会通过 copy_process 将父进程的所有资源拷贝到子进程中，这其中也包括父进程的虚拟内存空间。

当这个进程被调度到某个 CPU 之上时，内核就会调用 context_switch 来对进程上下文进行切换，切换的内容主要包括：
* 进程虚拟内存空间的切换。
* 寄存器以及进程栈的切换。

## 单级页表

在 32 位系统中，页表中的一个 PTE 占用 4B 大小，所以一张页表可以容纳 1024 个 PTE。一个 PTE 可以映射 4K 的物理内存，那么一张页表就可以映射 1024 * 4K = 4M 大小的物理内存 。4G内存需要 1024 张页表，一张页表占用 4K 物理内存，所以为了映射 4G 的物理内存，需要 4M 的物理内存（1024张页表）来映射。100个进程需要400M连续物理内存。

## 多级页表

* 32位采用二级页表：PDE+PTE
* 64位采用四级页表：PGD+PUD+PMD+PTE

CR3 寄存器现在存放的是页目录表的起始物理内存地址。

虚拟内存地址格式：
|页目录表中PDE的偏移|一级页表中PTE的偏移|物理内存页内偏移|
|:--:|:--:|:--:|
|10位|10位|12位|

# CPU寻址

专门对页表进行遍历的地址翻译硬件 MMU（Memory Management Unit）。

MMU 中的硬件缓存就叫做 TLB(Translation Lookaside Buffer)。
